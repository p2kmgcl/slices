<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="twitter-stream.html">
<script src="../bower_components/oauth-js/dist/oauth.js"></script>

<dom-module id="twitter-slices">
    <template>
        <twitter-stream id="stream"></twitter-stream>
    </template>
    
    <script>
    /*global Polymer, OAuth*/

    Polymer({
        is: 'twitter-slices',

        properties: {
            query: {
                type: String,
                value: '#twitter'
            },
            language: {
                type: String,
                value: ''
            },
            preferImages: {
                type: Boolean,
                value: true
            },
            fetchingInterval: {
                type: Number,
                value: 10000
            },
            renderingInterval: {
                type: Number,
                value: 5000
            },
            maximumLength: {
                type: Number,
                value: 100
            },

            _tweetBuffer: {
                type: Array,
                value: function () {
                    return [];
                }
            }
        },

        ready: function () {
            this._fetchTweets = this._fetchTweets.bind(this);
            this._renderTweets = this._renderTweets.bind(this);
            this._cleanTweets = this._cleanTweets.bind(this);
            this._cleanString = this._cleanString.bind(this);
            this._getTweetScore = this._getTweetScore.bind(this);
            this._compareTweets = this._compareTweets.bind(this);
            this._hasTweet = this._hasTweet.bind(this);
            
            OAuth.initialize('S_qGDODdvXcjRgntfzvX9V_2jbg');
            OAuth.popup('twitter')
            .done((function (result) {
                this._connection = result;
                this._fetchTweets();
                this._renderTweets();
            }).bind(this))
            .fail(function (error) {
                console.log('Authentication error');
                console.log(error);
            });
        },

        _fetchTweets: function () {
            var url = [
                '/1.1/search/tweets.json',
                [
                    ['q', encodeURIComponent(this.query)].join('='),
                    ['lang', encodeURIComponent(this.language)].join('='),
                    ['result_type', 'recent'].join('='),
                    ['count', 100].join('='),
                    ['include_entities', true].join('=')
                ].join('&')
            ].join('?');
            
            this._connection.get(url)
            .done((function (result) {
                this._cleanTweets(result.statuses);
                setTimeout(this._fetchTweets, this.fetchingInterval);
            }).bind(this))
            .fail(function () {
                console.log('Error fetching tweets');
                console.log(arguments);
            });
        },

        _cleanString: function (text) {
            if (typeof text !== 'string') {
                text = '';   
            }
            text = text.toLowerCase();
            text = text.replace(/https?:\/\/[^ ]+/g, '');
            var element = document.createElement('div');
            element.innerHTML = text;
            return element.textContent || element.innerText || '';
        },
        
        _getTweetScore: function (tweet) {
            var score = 0,
                source = this._cleanString(tweet.source);
            
            if (source.indexOf('twitter ads') !== null) { score -= 100; }
            if (source.indexOf('twittbot') !== null) { score -= 100; }
            if (source.indexOf('buffer') !== null) { score -= 50; }
            if (source.indexOf('ifttt') !== null) { score -= 50; }

            if (this.preferImages) {
                if (tweet.entities.media && tweet.entities.media.length > 0) {
                    score += 100;
                }
            }

            score -= parseInt((new Date() - new Date(tweet.created_at)) / 1000, 10);
            score += tweet.retweet_count;
            score += tweet.favorite_count;
            return score;
        },
        
        _compareTweets: function (tweet1, tweet2) {
            return this._getTweetScore(tweet2) - this._getTweetScore(tweet1);
        },
        
        _hasTweet: function (tweet) {
            var i;

            for (i = 0; i < this._tweetBuffer.length; i++) {
                if (this._cleanString(tweet.text) ===
                    this._cleanString(this._tweetBuffer[i].text)) {
                    return true;
                }
            }

            for (i = 0; i < this.$.stream.tweets.length; i++) {
                if (this._cleanString(tweet.text) ===
                    this._cleanString(this.$.stream.tweets[i].text)) {
                    return true;
                }
            }
            return false;
        },

        _cleanTweets: function (tweets) {
            for (var i = 0; i < tweets.length; i++) {
                var tweet = tweets[i];
                if (this._hasTweet(tweet)) {
                    continue;
                }
                this._tweetBuffer.push(tweet);
            }

            this._tweetBuffer.sort(this._compareTweets);
            var bufferLimit = this.maximumLength,
                bufferLength = this.maximumLength / 2,
                streamLimit = this.maximumLength / 2,
                streamLength = this.maximumLength / 4;

            if (this._tweetBuffer.length > bufferLimit) {
                while (this._tweetBuffer.length > bufferLength) {
                    this._tweetBuffer.pop();
                }
            }
            if (this.$.stream.tweets.length > streamLimit) {
                while (this.$.stream.tweets.length > streamLength) {
                    this.$.stream.pop('tweets');
                }
            }
        },

        _renderTweets: function () {
            if (this._tweetBuffer.length > 0) {
                this.$.stream.unshift('tweets', this._tweetBuffer.shift());
            }
            setTimeout(this._renderTweets, this.renderingInterval);
        }
    });
    </script>
</dom-module>
