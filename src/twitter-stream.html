<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="twitter-tweet.html">

<dom-module id="twitter-stream">
    <template>
        <style type="text/css">
            twitter-tweet {
                float: left;
                width: 98%;
                margin: 1%;
            }

            @media (min-width:320px) {
                twitter-tweet { width: 98%; }
            }
            @media (min-width:481px) {
                twitter-tweet { width: 98%; }
            }
            @media (min-width:641px) {
                twitter-tweet { width: 48%; }
            }
            @media (min-width:961px) {
                twitter-tweet { width: 31.3334%; }
            }
            @media (min-width:1025px) {
                twitter-tweet { width: 31.3334%; }
            }
            @media (min-width:1281px) {
                twitter-tweet { width: 23%; }
            }
        </style>
        
        <div id="stream"></div>
    </template>
    
    <script src="../bower_components/masonry/dist/masonry.pkgd.js"></script>
    <script>
    /*global Polymer, Masonry, TwitterTweet*/

    Polymer({
        is: 'twitter-stream',

        properties: {
            tweets: {
                type: Array,
                reflectToAttribute: true,
                value: function () {
                    return [];
                }
            }
        },
        
        observers: [
            '_updateGrid(tweets.splices)'  
        ],

        listeners: {
            'tweet-render': '_updateGrid'
        },
        
        ready: function () {
            this.masonry = new Masonry(this.$.stream, {
                itemSelector: 'twitter-tweet'
            });
        },
        
        _tweetId: function (tweet) {
            return "tweet-" + tweet.id;
        },
        
        _updateGrid: function (splicesInfo) {
            if (typeof splicesInfo !== 'object') {
                return;

            } else if (splicesInfo instanceof Event) {
                this.masonry.layout();
                return;
            }
            
            splicesInfo.indexSplices.forEach(function (splice) {
                splice.removed.forEach(function (tweet) {
                    this.masonry.remove(this.$$(this._tweetId(tweet)));
                    this.masonry.layout();
                }, this);
                
                for (var i = 0; i < splice.addedCount; i++) {
                    var tweet = splice.object[splice.index + i],
                        $tweet = document.createElement('twitter-tweet');

                    $tweet.id = this._tweetId(tweet);
                    $tweet.setAttribute('text', tweet.text);
                    $tweet.setAttribute('user-name', tweet.user.screen_name);
                    $tweet.setAttribute('user-real-name', tweet.user.name);
                    $tweet.setAttribute('user-image', tweet.user.profile_image_url);
                    $tweet.setAttribute('entities', JSON.stringify(tweet.entities));
                    $tweet.setAttribute('retweet-count', tweet.retweet_count);
                    $tweet.setAttribute('favorite-count', tweet.favorite_count);

                    var previousTweet = Polymer.dom(this.$.stream).firstChild;
                    if (previousTweet) {
                        Polymer.dom(this.$.stream).insertBefore($tweet, previousTweet);
                    } else {
                        Polymer.dom(this.$.stream).appendChild($tweet);
                    }
                    this.masonry.prepended($tweet);
                    this.masonry.layout();
                }
            }, this);
        }
    });
    </script>
</dom-module>
